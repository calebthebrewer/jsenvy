(function(window) {
	//export a global to work with
	window.jsenvy = {};
})(window);
(function(jsenvy, document) {
	jsenvy.libraries = {
		preload: preload,
		search: search,
		load: load,
		loaded: loaded,
		callback: callback
	};

	var cdnjsLibraries = [],
		filesLoaded = [],
		callbacks = [];

	function preload() {
		get("http://api.cdnjs.com/libraries", function (data) {
			var results = JSON.parse(data.response).results;
			//sort these once here
			results.sort(function (a, b) {
				return a.name.length - b.name.length;
			});

			cdnjsLibraries = results;
		});
	}

	function search(query) {
		var results = [];

		for (var i = 0; i < cdnjsLibraries.length; i++) {
			if (cdnjsLibraries[i].name.indexOf(query) > -1) {
				results.push(cdnjsLibraries[i]);
			}
		}

		return results;
	}

	function load(file, callback) {
		//fail fast
		if (!file) {
			return;
		}
		if (filesLoaded.indexOf(file) >= 0) {
			return callback(false, "We already got this for you.");
		}

		//create a script
		var script = document.createElement("script");
		script.src = file;
		script.asynch = true;
		script.onreadystatechange = script.onload = function () {
			var state = script.readyState;
			if (!callback.done && (!state || /loaded|complete/.test(state))) {
				filesLoaded.push(file);
				//clear the dishes
				callback.done = true;
				clearTimeout(validator);
				callbacks.forEach(function (fn) {
					fn(file);
				});
				callback(true);
			}
		};
		document.body.appendChild(script);

		//create a limit
		var validator = setTimeout(function () {
			if (!callback.done)
				script.remove();
			callback(false, "This little guy didn't make it on time: " + file);
		}, 2000);

		//analytics
		if (window.ga !== undefined) {
			window.ga('send', 'event', 'load', file);
		}
	}

	function loaded() {
		return filesLoaded;
	}

	function callback(fn) {
		callbacks.push(fn);
	}

	//our friendly neighborhood ajax http request
	function get(url, callback) {

		var xhr;

		if (typeof XMLHttpRequest !== "undefined")
			xhr = new XMLHttpRequest();
		else {
			var versions = [
				"MSXML2.XmlHttp.5.0",
				"MSXML2.XmlHttp.4.0",
				"MSXML2.XmlHttp.3.0",
				"MSXML2.XmlHttp.2.0",
				"Microsoft.XmlHttp"
			];

			for (var i = 0, len = versions.length; i < len; i++) {
				try {
					xhr = new ActiveXObject(versions[i]);
					break;
				} catch (e) {
				}
			}
		}
		xhr.onreadystatechange = ensureReadiness;
		function ensureReadiness() {
			if (xhr.readyState < 4) {
				return;
			}
			if (xhr.status !== 200) {
				return;
			}
			if (xhr.readyState === 4) {
				callback(xhr);
			}
		}

		xhr.open("GET", url, true);
		xhr.send("");
		return xhr;
	}

})(jsenvy, document);
(function(jsenvy) {
	jsenvy.persist = {
		get: getFromHash,
		put: putInHash,
		post: postInHash,
		remove: removeFromHash,
		if: ifHash
	};

	function getFromHash(where) {
		var regex = new RegExp('[\\#]' + where + '=([^#]*)'),
			results = regex.exec(location.hash);
		return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
	}

	function putInHash(what, where) {
		var regex = new RegExp(where + '=([^#]*)');
		if (!regex.exec(location.hash)) return postInHash(what, where);
		location.hash = location.hash.replace(regex, where + '=' + encodeURIComponent(what));
	}

	function postInHash(what, where) {
		removeFromHash(where);
		location.hash = ifHash(what, where);
	}

	function removeFromHash(where) {
		var regex = new RegExp('[#]' + where + '=([^#]*)');
		location.hash = location.hash.replace(regex, '');
	}

	function ifHash(what, where) {
		return location.hash + '#' + where + '=' + encodeURIComponent(what);
	}
})(jsenvy);
(function (jsenvy, document, window) {
	jsenvy.console = {
		log: log,
		history: history,
		callback: callback
	};
	//keep track of this guy!
	var _console = window.console;
	//elements
	var consoleLog = document.getElementById('console-log'),
		consoleForm = document.getElementById('console-form'),
		consoleInput = document.getElementById('console-input');
	//templates
	var templates = {
		log: document.getElementById('log-template'),
		error: document.getElementById('error-template')
	};
	//random variables
	var consoleHistoryIndex = 0,
		callbacks = [];

	//attach events
	consoleForm.onsubmit = function (e) {
		e.preventDefault();
		log();
	};

	consoleInput.onkeyup = function (e) {
		switch (e.keyCode) {
			case 38: //"up"
				consoleHistory(-1);
				break;
			case 40: //"down"
				consoleHistory(+1);
				break;
			default:
				break;
		}
	};

	function callback(fn) {
		callbacks.push(fn);
	}

	function runCallbacks() {
		callbacks.forEach(function (fn) {
			fn();
		});
	}

	function log(value) {
		var expression = value || consoleInput.value;
		if (expression === '') return;

		consoleInput.value = '';
		//here is the magic
		try {
			var value = eval(expression),
				entry = templates.log.cloneNode();

			entry.title = expression;
			entry.innerHTML = value;
			consoleLog.appendChild(entry);
		} catch (error) {
			var entry = templates.error.cloneNode();

			entry.title = expression;
			entry.innerHTML = error.message;
			consoleLog.appendChild(entry);
		}
		//keep the console at the bottom
		consoleLog.scrollTop = consoleLog.scrollHeight;
		consoleHistoryIndex = consoleLog.childElementCount;
		runCallbacks();
	}

	function consoleHistory(operation) {
		if (consoleHistoryIndex + operation > -1 &&
			consoleHistoryIndex + operation <= consoleLog.childElementCount) {
			consoleHistoryIndex = consoleHistoryIndex + operation;
		}
		if (consoleHistoryIndex === consoleLog.childElementCount) {
			consoleInput.value = '';
		} else if (consoleLog.childElementCount) {
			consoleInput.value = consoleLog.children[consoleHistoryIndex].title;
		}
	}

	function history() {
		var logs = consoleLog.children,
			statements = [];

		for (var i = 0, l = logs.length; i < l; i++) {
			statements.push(logs[i].title);
		}

		return statements;
	}

	//process templates
	(function () {
		for (var template in templates) {
			var cloned = templates[template].cloneNode();
			cloned.id = '';
			templates[template].remove();
			templates[template] = cloned;
		}
	})();
})(jsenvy, document, window);
(function (jsenvy) {

	loadLibrariesFromSearch(runLogsFromSearch);

	function loadLibrariesFromSearch(callback) {
		var libraries = jsenvy.persist.get('libs').split(',');

		if (!libraries || !libraries.length || !libraries[0]) {
			callback();
			return;
		}

		loadLibrary(libraries, callback);

		function loadLibrary(library, callback) {
			if (typeof library === 'object' && library.length) {
				jsenvy.libraries.load(library.shift(), function () {
					loadLibrary(library, callback);
				}, true);
			} else {
				callback();
			}
		}
	}

	function runLogsFromSearch(callback) {
		var logs = jsenvy.persist.get('logs').split(',,');

		if (!logs || !logs.length || !logs[0]) {
			if (typeof callback === 'function') callback();
			return;
		}

		loadLog(logs, callback);

		function loadLog(log, callback) {
			if (typeof log === 'object' && log.length) {
				jsenvy.console.log(log.shift());
				window.setTimeout(function () {
					loadLog(log, callback);
				}, 500);
			} else {
				if (typeof callback === 'function') callback();
			}
		}
	}
})(jsenvy);